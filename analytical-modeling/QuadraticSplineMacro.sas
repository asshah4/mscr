%macro rqspline(data=_last_,x=,event=,k=,equal=,cases=);
options nonotes;
%local _p_ _z_;
data &data;
set &data;
_z_=1;
%if &equal=0 %then %do;
%if &cases=0 %then %do;
proc univariate data=&data noprint;
var &x; output out=_p_ pctlpts=3 5 18 23 28 34 35 41 50 59 65 66 73 77 82 95 98 pctlpre=p;
%end;
%if &cases=1 %then %do;
proc univariate data=&data noprint;
where &event=1; var &x; output out=_p_ pctlpts=3 5 18 23 28 34 35 41 50 59 65 66 73 77 82 95 98 pctlpre=p;
%end; %end;
%if &equal=1 %then %do;
%if &cases=0 %then %do;
proc univariate data=&data noprint;
var &x; output out=_p_ pctlpts=12 15 16 20 24 25 29 33 37 40 43 50 57 60 63 67 71 75 76 80 84 85 88 pctlpre=p;
%end;
%if &cases=1 %then %do;
proc univariate data=&data noprint;
where &event=1; var &x; output out=_p_ pctlpts=12 15 16 20 24 25 29 33 37 40 43 50 57 60 63 67 71 75 76 80 84 85
88 pctlpre=p;
%end; %end;
data _p_;
set _p_;
_z_=1;
if &k=3 and &equal=0 then put "Knots for &x =" p5 p50 p95;
else if &k=3 and &equal=1 then put "Knots for &x =" p25 p50 p75;
if &k=4 and &equal=0 then put "Knots for &x =" p5 p35 p65 p95;
else if &k=4 and &equal=1 then put "Knots for &x =" p20 p40 p60 p80;
if &k=5 and &equal=0 then put "Knots for &x =" p5 p28 p50 p73 p95;
else if &k=5 and &equal=1 then put "Knots for &x =" p16 p33 p50 p67 p84;
if &k=6 and &equal=0 then put "Knots for &x =" p5 p23 p41 p59 p77 p95;
else if &k=6 and &equal=1 then put "Knots for &x =" p15 p29 p43 p57 p71 p85;
if &k=7 and &equal=0 then put "Knots for &x =" p3 p18 p34 p50 p66 p82 p98;
else if &k=7 and &equal=1 then put "Knots for &x =" p12 p24 p37 p50 p63 p76 p88;
data &data;
merge &data _p_;
by _z_;
drop _z_;
data &data;
set &data;
%if &equal=0 %then %do;
%if &k=3 %then %do;
_&x=(max(0,&x-p5)**2-max(0,&x-p95)**2)/(p95-p5);
__&x=(max(0,&x-p50)**2-max(0,&x-p95)**2)/(p95-p5);
%end;
%else %if &k=4 %then %do;
_&x=(max(0,&x-p5)**2-max(0,&x-p95)**2)/(p95-p5);
__&x=(max(0,&x-p35)**2-max(0,&x-p95)**2)/(p95-p5);
___&x=(max(0,&x-p65)**2-max(0,&x-p95)**2)/(p95-p5);
%end;
%else %if &k=5 %then %do;
_&x=(max(0,&x-p5)**2-max(0,&x-p95)**2)/(p95-p5);
__&x=(max(0,&x-p28)**2-max(0,&x-p95)**2)/(p95-p5);
___&x=(max(0,&x-p50)**2-max(0,&x-p95)**2)/(p95-p5);
____&x=(max(0,&x-p73)**2-max(0,&x-p95)**2)/(p95-p5);
%end;
%else %if &k=6 %then %do;
_&x=(max(0,&x-p5)**2-max(0,&x-p95)**2)/(p95-p5);
__&x=(max(0,&x-p23)**2-max(0,&x-p95)**2)/(p95-p5);
___&x=(max(0,&x-p41)**2-max(0,&x-p95)**2)/(p95-p5);
____&x=(max(0,&x-p59)**2-max(0,&x-p95)**2)/(p95-p5);
_____&x=(max(0,&x-p77)**2-max(0,&x-p95)**2)/(p95-p5);
%end;
%else %if &k=7 %then %do;
_&x=(max(0,&x-p3)**2-max(0,&x-p98)**2)/(p98-p3);
__&x=(max(0,&x-p18)**2-max(0,&x-p98)**2)/(p98-p3);
___&x=(max(0,&x-p34)**2-max(0,&x-p98)**2)/(p98-p3);
____&x=(max(0,&x-p50)**2-max(0,&x-p98)**2)/(p98-p3);
_____&x=(max(0,&x-p66)**2-max(0,&x-p98)**2)/(p98-p3);
______&x=(max(0,&x-p82)**2-max(0,&x-p98)**2)/(p98-p3);
%end; %end;
%if &equal=1 %then %do;
%if &k=3 %then %do;
_&x=(max(0,&x-p25)**2-max(0,&x-p75)**2)/(p75-p25);
__&x=(max(0,&x-p50)**2-max(0,&x-p75)**2)/(p75-p25);
%end;
%else %if &k=4 %then %do;
_&x=(max(0,&x-p20)**2-max(0,&x-p80)**2)/(p80-p20);
__&x=(max(0,&x-p40)**2-max(0,&x-p80)**2)/(p80-p20);
___&x=(max(0,&x-p60)**2-max(0,&x-p80)**2)/(p80-p20);
%end;
%else %if &k=5 %then %do;
_&x=(max(0,&x-p16)**2-max(0,&x-p84)**2)/(p84-p16);
__&x=(max(0,&x-p33)**2-max(0,&x-p84)**2)/(p84-p16);
___&x=(max(0,&x-p50)**2-max(0,&x-p84)**2)/(p84-p16);
____&x=(max(0,&x-p67)**2-max(0,&x-p84)**2)/(p84-p16);
%end;
%else %if &k=6 %then %do;
_&x=(max(0,&x-p15)**2-max(0,&x-p85)**2)/(p85-p15);
__&x=(max(0,&x-p29)**2-max(0,&x-p85)**2)/(p85-p15);
___&x=(max(0,&x-p43)**2-max(0,&x-p85)**2)/(p85-p15);
____&x=(max(0,&x-p57)**2-max(0,&x-p85)**2)/(p85-p15);
_____&x=(max(0,&x-p71)**2-max(0,&x-p85)**2)/(p85-p15);
%end;
%else %if &k=7 %then %do;
_&x=(max(0,&x-p12)**2-max(0,&x-p88)**2)/(p88-p12);
__&x=(max(0,&x-p24)**2-max(0,&x-p88)**2)/(p88-p12);
___&x=(max(0,&x-p37)**2-max(0,&x-p88)**2)/(p88-p12);
____&x=(max(0,&x-p50)**2-max(0,&x-p88)**2)/(p88-p12);
_____&x=(max(0,&x-p63)**2-max(0,&x-p88)**2)/(p88-p12);
______&x=(max(0,&x-p76)**2-max(0,&x-p88)**2)/(p88-p12);
%end; %end;
drop p3 p5 p12 p15 p16 p18 p20 p23 p24 p25 p28 p29 p33 p34 p35 
p37 p40 p41 p43 p50 p57 p59 p60 p63 p65 p66
p67 p71 p73 p75 p76 p77 p80 p82 p84 p85 p88 p95 p98;
run; quit; run;
options notes;
%mend;

****to create a dataset with basis spline function using macro;
*Specify the continuous variable for which the spline basis functions are to be constructed (i.e., x); 
*Choose the number of knots (i.e., k), range of 3-7 was recommended;
*Specify whether the knot to be at an equal interval or not (1 is equal intervals);

%rqspline(data=????,x=??????,event=??????,k=?????,equal=??????,cases=??????);
